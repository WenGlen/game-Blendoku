/* ================ Reset (trimmed) ================ */
*,
*::before,
*::after { box-sizing: border-box;   border: 0;}

html, body, div, span, applet, object, iframe,
h1, h2, h3, h4, h5, h6, p, blockquote, pre,
a, abbr, acronym, address, big, cite, code,
del, dfn, em, img, ins, kbd, q, s, samp,
small, strike, strong, sub, sup, tt, var, b, u, i, center,
dl, dt, dd, ol, ul, li, fieldset, form, label, legend,
table, caption, tbody, tfoot, thead, tr, th, td,
article, aside, canvas, details, embed, figure, figcaption,
footer, header, hgroup, menu, nav, output, ruby, section, summary,
time, mark, audio, video {
  margin: 0; padding: 0; border: 0;
  font: inherit; font-size: 100%; vertical-align: baseline;
}
article, aside, details, figcaption, figure, footer, header, hgroup, menu, nav, section { display: block; }
ol, ul { margin: 0; padding-left: 32px; }
blockquote, q { quotes: none; }
blockquote::before, blockquote::after, q::before, q::after { content: ''; }
table { border-collapse: collapse; border-spacing: 0; }

/* ================ Tokens ================ */
:root {
  /* viewport fix */
  --vh: 1vh;

  /* sizing */
  --radius: 8px;
  --button-size: 32px;
  --button-radius: 8px;
  --button-font-size: 8px;

  --gap: 8px;
  --grid-size: 55px;
  --grid-radius: 8px;

  /* type */
  --font-size-h1: clamp(20px, 10vh, 20vh);
  --font-size-h2: 20px;
  --font-size-h3: 14px;
  --font-size-body: 12px;
  --font-size-small: 12px;

  /* color */
  --color-primary: #0a88a3;
  --color-primary2: #004d99;
  --color-primary-light: #39abbd;
  --color-secondary: #ffbf00;
  --color-secondary2: #ffd300;
  --color-warning: #ff80bf;
  --color-temp: #666;

  --color-gray90: #202830;
  --color-gray80: #303c49;
  --color-gray70: #3f4f61;
  --color-gray60: #4f6379;
  --color-gray50: #5f7791;
  --color-gray40: #7a8ea3;
  --color-gray30: #94a4b6;
  --color-gray20: #afbbc8;
  --color-gray10: #e4e8ed;
  --color-gray05: #e4e8ed; /* same as gray10; keep for compatibility */

  --color-bg-dark: var(--color-gray90);
  --color-container-dark: var(--color-gray70);
  --color-bg-light: #f5f5dc;
  --color-container-light: #264c58;
  --color-border: #5e86c1;
}

/* ================ Base ================ */
html { font-size: 16px; }
body {
  height: 100%;
  background: var(--color-bg-dark);
  line-height: 1;
  overflow: hidden;
}
.hidden { display: none !important; }

button {
  margin: 0 1vh;
  padding: 1vh 3vh;

  border: 0;
  border-radius: var(--radius);
  background: var(--color-gray10);
  cursor: pointer;

  font-size: 2vh;

  color: var(--color-gray90);
}

/* ================ Stage / Viewport ================ */

#game-wrap {
  position: relative;
  width: 100vw;
  height: calc(var(--vh, 1vh) * 100); /* unified 100vh fix */
  overflow: hidden;
  background: #000;
  touch-action: none;
  padding: 4vh;
  padding-left:  max(4vh, env(safe-area-inset-left));
  padding-right: max(4vh, env(safe-area-inset-right));
  padding-top:   max(4vh, env(safe-area-inset-top));
  padding-bottom:max(4vh, env(safe-area-inset-bottom));
}

#game-stage {
  width: 360px;
  height: 640px;
  position: absolute;
  left: 50%;
  top: 50%;
  transform-origin: center;
}

/* ================ Typography / Controls ================ */

h1 { font-size: var(--font-size-h1); }
.tips { font-size: clamp(12px, 3.5vw, 16px); }

.btn {
  padding: 2vh;
  border-radius: .75rem;
  font-size: clamp(13px, 3.8vw, 15px);
  color: var(--color-gray90);
  background: var(--color-gray10);
  border: 1px solid transparent;
  cursor: pointer;
  border: 0;

  &.primary {
    background: var(--color-primary);
    color: var(--color-gray10);
    font-weight: bold;
    font-size: 2vh;

    &:hover { background: var(--color-primary-light); }
  }
  &.ghost {
    background: transparent;
    color: var(--color-gray20);
  }
}



/* Â∞èÊ©üÁ®ÆÂæÆË™ø */
@media (max-width: 360px) {
  .btn { padding: .5rem .75rem; }
}

/* ÂØ¨Áï´Èù¢ÂèØÈ°ØÁ§∫ÂÅ¥Ê¨Ñ */
@media (min-aspect-ratio: 9/16) {
  .side-panel { display: block; }
}

/* ================ Layout ================ */
.wrap {
  position: relative;
  display: flex; flex-direction: column;
  max-width: 50vh; height: 100vh;
  margin: 0 auto; padding: 2vh;
  overflow: hidden;
}


/* ================ header ================ */

.header {
  display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;
  width: 100%; height: 8vh; margin: 0 auto 2vh;
  background: var(--color-container-dark); border-radius: var(--radius);

  .logo {
    width: 4vh; height: 4vh; margin: 2vh;
    img { width: 100%; height: auto; }
  }
  .levelNum {
    font-family: monospace; font-size: 4vh; font-weight: bold; line-height: 1.5; text-align: center;
    color: var(--color-gray20);
  }
}

.icon-btn2 {
  background: transparent; width: 3vh; height: 3vh; padding: 0; margin: 2vh;
  img { width: 100%; height: auto; }
}
.homeIcon { opacity: .5; cursor: pointer; &:hover { opacity: .7; } }

/* ================ panel ================ */

.panel {
  position: relative;
  display: flex; flex-direction: column; flex-grow: 1;
  width: 100%; margin: 0 auto; padding: 4vh;
  background: var(--color-container-dark); border-radius: var(--radius);
}

/* Boards */
.grid-board { display: grid; justify-content: center; }
.start-board { display: flex; justify-content: center; flex-wrap: wrap; }

.fixed-tile { cursor: not-allowed; }

/* Cells / Tiles (unified) */
.cell,
.tile {
  width: var(--grid-size);
  height: var(--grid-size);
  border-radius: var(--grid-radius);
}
.cell {
  position: relative; display: flex; align-items: center; justify-content: center;
  border: 1px solid var(--color-gray70);
  background: var(--color-gray90);

  &.fixed::after {
    content: "üîí";
    position: absolute; top: 4px; right: 4px; font-size: 14px; opacity: .7;
  }
  &.hidden-cell {
    background-color: var(--color-container-dark);
    pointer-events: none;
  }
}
.tile { cursor: grab; }
.tile.locked { cursor: default; }

.gap-line { height: 2px; margin: 4vh 0; background: var(--color-gray60); }
.gap-space { flex-grow: 1; width: 100%; }

.info-bar {
  display: flex; justify-content: space-between; align-items: center;
  margin-top: 2vh; margin-bottom: -1vh; padding: 1vh 2vh;
  border-radius: var(--radius); background: var(--color-gray80);
  font-size: 1.5vh; color: var(--color-gray20);
}

.count-bar {
  display: flex; flex-direction: column;
}
.counter {
  display: inline-block; width: var(--counter-w, auto);
  text-align: right; font-family: monospace;
  margin: 0.5vh;
}


.icon-btn3 {
  background: transparent; width: 2vh; height: 2vh; padding: 0; margin: 1vh;
  
  img { width: 100%; height: auto; }

  opacity: .6; cursor: pointer; 
  &:hover { opacity: .8; } 
  &:disabled {opacity: 0.2;pointer-events: none;cursor: default;}
  
}



/*
.switchIcon { 
  opacity: .5; cursor: pointer; 
  &:hover { opacity: .7; } 
  &:disabled {opacity: 0.3;pointer-events: none;cursor: default;}
}
*/
#step-count { --counter-w: 48px; }
#timer      { --counter-w: 48px; }

/* ================ Main Menu ================ */
#main-menu {
  position: absolute; inset: 2vh; z-index: 200;
  display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2vh; text-align: center;
  margin: 0 auto; padding: 4vh;
  background: var(--color-container-dark); border-radius: var(--radius);

  h1 { color: var(--color-gray10); font-size: var(--font-size-h1); }
}
.menu-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 16px 0 20px; }
.level-grid   { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
.level-btn {
  padding: 1vh 1.5vh; border-radius: var(--button-radius);
  background: var(--color-gray60); color: var(--color-gray20); font-weight: bold;

  &:hover { background: var(--color-gray50); }
  &:disabled { opacity: .5; cursor: not-allowed; }
}

/* ================ Popup ================ */
.popup {
  position: fixed; inset: 0;
  display: flex; align-items: center; justify-content: center;
  background: rgba(0,0,0,.4); z-index: 100;
}
.popup-content {
  padding: 4vh; border-radius: var(--radius); background: var(--color-gray70);
  text-align: center; line-height: 1;

  h3 { color: var(--color-gray10); font-size: 3vh; line-height: 1.5; }
  &.pass-record {
    height: 2vh; display: flex; justify-content: space-around; align-items: center;
    color: var(--color-gray30); font-size: 1.5vh;
  }
}
.popup-header{
  width: 100%; margin-bottom: 1vh;
  display: flex; align-items: flex-end;
}

#popup-close{
  margin-left: auto;
  opacity: 0.7;
  &:hover {
      opacity: 1;
    }
}

/* ================ Footer ================ */
.footer{
  width: 100%; height: 4vh; margin-top: 2vh; padding: 1vh 2vh;
  background: var(--color-container-dark); border-radius: var(--radius);
  display: flex; justify-content: space-between; align-items: center;

  p { font-size: 12px; color: var(--color-gray40); text-align: center; }
}

/* ================ Overlay / Tutorial Shell ================ */
.overlay {
  position: absolute; inset: 0; z-index: 300;
  display: flex; align-items: center; justify-content: center;
  background: rgba(0,0,0,.5);
}

.tutorial-card {
  position: absolute; 
  inset: 2vh; 
  z-index: 300; box-sizing: border-box;
  flex-grow: 1; margin: 0 auto; padding: 25vh 4vh;
  background: var(--color-container-dark); border-radius: var(--radius); color: var(--color-gray10);
  display: flex; flex-direction: column; gap: 1.6vh;
  overflow: hidden; 
}
.tutorial-header { display:flex; justify-content:space-between; align-items:center; margin-bottom: 2vh; }
.tutorial-title  { font-size: 2.4vh; font-weight: bold; }
.icon-btn        { background: transparent; border: 0; color: var(--color-gray30); font-size: 20px; cursor: pointer; padding: 0; }
.tutorial-body   { min-height: 28vh; }
.t-step          { display: none; }
.t-step.active   { display: block; }
.t-step h3       { font-size: 2.2vh; margin-bottom: .8vh; color: var(--color-gray10); line-height: 1.5; }
.t-step p        { font-size: 1.6vh; color: var(--color-gray20); margin-bottom: 1.4vh; }
.tutorial-footer { display:flex; justify-content: space-between; align-items:center; }
.dots            { display:flex; gap: 8px; }
.dots .dot       { width: 8px; height: 8px; border-radius: 50%; background: var(--color-gray50); opacity:.5; }
.dots .dot.active{ opacity:1; background: var(--color-secondary); }
.demo { border-radius: var(--radius); padding: 1.2vh; }

/* ========= Shared demo variables (reuse main tokens) ========= */
:root { --step: calc(var(--grid-size) + var(--gap)); }

/* ========= Shared demo parts ========= */
.grid { display: grid; grid-template-columns: repeat(3, var(--grid-size)); gap: var(--gap); justify-content: center; }
.cell { /* already defined above; keep shape consistent */ }
.cell.empty { background: transparent; border-style: dashed; }
.tile { /* already defined above */ }

.demo-panel { padding: 2vh; }

/* ========= Shared cursor-hand baseline (override per step as needed) ========= */
.cursor-hand {
  position: absolute;
  z-index: 10;
  width: 28px;
  pointer-events: none;
  transition: none !important; /* avoid unwanted easing */
  will-change: transform, opacity;
}

/* ===== Step 1 (colors preview) ===== */
.demo-gradients {
  display: flex; flex-direction: column; gap: 3vh;

  .grid { display: flex; gap: 0; }
  .tile.color1 { background: #0c6b00; }
  .tile.color2 { background: #4d8f13; }
  .tile.color3 { background: #86a927; }
  .tile.color4 { background: #ffe14d; }
  .tile.color5 { background: #004d99; }
  .tile.color6 { background: #007ba7; }
  .tile.color7 { background: #76bad3; }
  .tile.color8 { background: #ebf9ff; }
}

/* ===== Step 2 ÂãïÁï´ ===== */
$S2_DUR: 5s;
$S2_MOVE_SLICE: 10%;

$grab1_start: 10%;  $grab1_end: 25%;
$moveR_start: 40%;  $moveR_end: 48%;
$grab2_start: 65%;  $grab2_end: 80%;
$moveL_start: 90%;  $moveL_end: 98%;

.pick-scene { 
  --cols: 3;
  --gridW: calc(var(--cols) * var(--grid-size) + (var(--cols) - 1) * var(--gap));
  --grid-left: calc(50% - var(--gridW) / 2); /* ÁΩÆ‰∏≠ÂæåÁöÑÂ∑¶Á∑£ */
  position: relative; 
}

.pick-t1 { background: var(--color-gray90); }
.pick-t2 { background: #86a927; }
.pick-t3 { background: #ffe14d; }

.pick-scene .mid .tile {
  animation: s2-lift $S2_DUR ease-in-out infinite;
  transform-origin: center;
}
@keyframes s2-lift {
  0%, #{ $grab1_start - 0.01% }     { transform: translateY(0); box-shadow: none; }
  #{$grab1_start}, #{$grab1_end}    { transform: translateY(-12px); box-shadow: 0 8px 16px rgba(0,0,0,.35); }
  #{$grab1_end + 0.01%}, 100%       { transform: translateY(0); box-shadow: none; }
}

.pick-scene .cursor-hand {
  left: calc(var(--grid-left) + 1 * var(--grid-size) + 2 * var(--gap));
  
}

@keyframes s2-cursor-idle {
  0%, #{ $grab1_start - 0.01% }     { opacity: 1; }
  #{$grab1_start}, #{$grab1_end}    { opacity: 0; }
  #{$grab1_end + 0.01% }, #{ $grab2_start - 0.01% } { opacity: 1; }
  #{$grab2_start}, #{$grab2_end}    { opacity: 0; }
  #{$grab2_end + 0.01%}, 100%       { opacity: 1; }
}
@keyframes s2-cursor-grab {
  0%, #{ $grab1_start - 0.01% }     { opacity: 0; }
  #{$grab1_start}, #{$grab1_end}    { opacity: 1; }
  #{$grab1_end + 0.01% }, #{ $grab2_start - 0.01% } { opacity: 0; }
  #{$grab2_start}, #{$grab2_end}    { opacity: 1; }
  #{$grab2_end + 0.01%}, 100%       { opacity: 0; }
}
@keyframes s2-move {
  0%, #{ $moveR_start - 0.01% }     { transform: translateX(0); }
  #{$moveR_end}                     { transform: translateX(var(--step)); }
  #{$grab2_end}, #{ $moveL_start - 0.01% } { transform: translateX(var(--step)); }
  #{$moveL_end}, 100%               { transform: translateX(0); }
}
.pick-scene .cursor-hand.idle {
  animation: s2-cursor-idle $S2_DUR steps(1, end) infinite,
             s2-move        $S2_DUR linear        infinite;
}
.pick-scene .cursor-hand.grabbing {
  animation: s2-cursor-grab $S2_DUR steps(1, end) infinite,
             s2-move        $S2_DUR linear        infinite;
}

/* ===== Step 3 ‰∫§ÊèõÂãïÁï´ ===== */
$S3_DUR: 5s;
$PAUSE_S: (0.5s / $S3_DUR) * 100%;
$PAUSE_L: (0.5s   / $S3_DUR) * 100%;

$P1: 10%;
$P2: 10.01%;
$P3: 40%;
$P4: 40.01%;
$P5S: $P4 + $PAUSE_S;
$P5E: $P5S + 0.01%;
$P6E: 70%;
$P7S: 70%;
$P7_RELEASE: 70.1%;
$RESET_AT: 99.9999%;

.demo-step3{
  --cols: 4;
  --gridW: calc(var(--cols) * var(--grid-size) + (var(--cols) - 1) * var(--gap));
  --grid-left: calc(50% - var(--gridW) / 2);
}

.demo-step3 .swap-scene {
  display: grid;
  grid-template-columns: repeat(4, var(--grid-size));
  gap: var(--gap);
  justify-content: center;
  position: relative;
}
.demo-step3 .tile      { position: relative; z-index: 1; }
.demo-step3 .tile-a    { z-index: 3; will-change: transform; background:#0c6b00; }
.demo-step3 .tile-b    { z-index: 2; background:#ffe14d; }

.demo-step3 .cursor-hand {
  left: calc(var(--grid-left) + 0.5 * var(--grid-size));
  display: block !important; 
}

@keyframes s3-cursor-idle {
  0%, #{$P1}                      { opacity:1; }
  #{$P1 + 0.01%}, #{$P4}          { opacity:0; }
  #{$P4 + 0.01%}, #{$P5S}         { opacity:1; }
  #{$P5S + 0.01%}, #{$P7_RELEASE} { opacity:0; }
  #{$P7_RELEASE + 0.01%}, 100%    { opacity:1; }
}
@keyframes s3-cursor-grab {
  0%, #{$P1}                      { opacity:0; }
  #{$P1 + 0.01%}, #{$P4}          { opacity:1; }
  #{$P4 + 0.01%}, #{$P5S}         { opacity:0; }
  #{$P5S + 0.01%}, #{$P7_RELEASE} { opacity:1; }
  #{$P7_RELEASE + 0.01%}, 100%    { opacity:0; }
}
.demo-step3 .cursor-hand.idle {
  animation: s3-cursor-idle $S3_DUR steps(1,end) infinite,
             s3-move        $S3_DUR linear       infinite !important;
}
.demo-step3 .cursor-hand.grabbing {
  animation: s3-cursor-grab $S3_DUR steps(1,end) infinite,
             s3-move        $S3_DUR linear       infinite !important;
}
@keyframes s3-move {
  0%, #{$P2 - 0.01%}                 { transform: translateX(0); }
  #{$P3}                             { transform: translateX(calc(2 * var(--step))); }
  #{$P4}, #{$P5S}, #{$P5E}           { transform: translateX(calc(2 * var(--step))); }
  #{$P6E}                            { transform: translateX(calc(3 * var(--step))); }
  #{$RESET_AT - 0.01%}               { transform: translateX(calc(3 * var(--step))); }
  100%                               { transform: translateX(0); }
}
@keyframes s3-a-path {
  0%, #{$P1}                         { transform: translateX(0) translateY(0); box-shadow:none; }
  #{$P2}                             { transform: translateX(0) translateY(-12px); box-shadow:0 8px 16px rgba(0,0,0,.35); }
  #{$P3}                             { transform: translateX(calc(2 * var(--step))) translateY(-12px); }
  #{$P4}                             { transform: translateX(calc(2 * var(--step))) translateY(0); box-shadow:none; }
  #{$P5S - 0.01%}                    { transform: translateX(calc(2 * var(--step))) translateY(0); }
  #{$P5E}                            { transform: translateX(calc(2 * var(--step))) translateY(-12px); box-shadow:none; }
  #{$P6E}                            { transform: translateX(calc(3 * var(--step))) translateY(-12px); box-shadow:none; }
  #{$P7_RELEASE}                     { transform: translateX(calc(3 * var(--step))) translateY(0); box-shadow:none; }
  #{$RESET_AT - 0.01%}               { transform: translateX(calc(3 * var(--step))) translateY(0); }
  100%                               { transform: translateX(0) translateY(0); }
}
.demo-step3 .tile-a { animation: s3-a-path $S3_DUR linear infinite !important; }
@keyframes s3-b-swap {
  0%, #{$P7_RELEASE - 0.01%}        { transform: translateX(0); }
  #{$P7_RELEASE}, #{$RESET_AT - 0.01%} { transform: translateX(calc(-1 * var(--step))); }
  100%                              { transform: translateX(0); }
}
.demo-step3 .tile-b { animation: s3-b-swap $S3_DUR steps(1,end) infinite !important; }

/* ===== Step 4 ÈÅéÈóúÂãïÁï´ ===== */
$S4_DUR: 3s;
$P_MOVE_END: 40%;
$P_DROP: 40.01%;
$P_POP_S: 40.01%;
$P_POP_E: 99.99%;
$P_RESET: 100%;

.demo-step4 { 
  --cols: 4; /* Step4 ÊòØ 4 Ê†º */
  --gridW: calc(var(--cols) * var(--grid-size) + (var(--cols) - 1) * var(--gap));
  --grid-left: calc(50% - var(--gridW) / 2); /* ÁΩÆ‰∏≠ÂæåÁöÑÂ∑¶Á∑£ */
  position: relative;
  transform: translateZ(0); /* ÈÅøÂÖç 1px ÊäñÂãïÔºàÂèØÁïôÂèØÊãøÊéâÔºâ */
}

.demo-step4 .finish-scene {
  position: relative;
  display: grid; grid-template-columns: repeat(4, var(--grid-size)); gap: var(--gap); justify-content: center; margin: 0 auto;
}
.demo-step4 .tile-a { background: #0c6b00; }
.demo-step4 .tile-c { background: #86a927; }
.demo-step4 .tile-d { background: #ffe14d; }

.demo-step4 .tile-b.floating{
  position: absolute; z-index: 3;
  width: var(--grid-size); height: var(--grid-size); border-radius: var(--grid-radius);
  background: #4d8f13; pointer-events: none;
  left: calc(1 * var(--step) + 0 * var(--grid-size));
  top:  calc(0 * var(--grid-size));
  animation: s4-path $S4_DUR linear infinite;
}
@keyframes s4-path {
  0%                        { transform: translateX(calc(-1.5 * var(--step))) translateY(-12px); }
  #{$P_MOVE_END}            { transform: translateX(calc( 0 * var(--step))) translateY(-12px); }
  #{$P_DROP}, #{$P_POP_E}   { transform: translateX(calc( 0 * var(--step))) translateY(0); }
  100%                      { transform: translateX(calc(-1.5 * var(--step))) translateY(-12px); }
}

.demo-step4 .cursor-hand {
  left: calc(1 * var(--step) + 0 * var(--grid-size));
  top:  calc(0.2 * var(--grid-size));
  display: block !important;

  &.idle {
    animation: s4-cursor-idle $S4_DUR steps(1,end) infinite,
               s4-move        $S4_DUR linear       infinite !important;
  }
  &.grabbing {
    animation: s4-cursor-grab $S4_DUR steps(1,end) infinite,
               s4-move        $S4_DUR linear       infinite !important;
  }
}
@keyframes s4-cursor-idle {
  0%                        { opacity: 0; }
  #{$P_DROP}, #{$P_POP_E}   { opacity: 1; }
  #{$P_POP_E + 0.01%},100%  { opacity: 0; }
}
@keyframes s4-cursor-grab {
  0%                        { opacity: 1; }
  #{$P_DROP}, #{$P_POP_E}   { opacity: 0; }
  #{$P_POP_E + 0.01%},100%  { opacity: 1; }
}
@keyframes s4-move {
  0%                        { transform: translateX(calc(-1.5 * var(--step))); }
  #{$P_MOVE_END}, #{$P_POP_E} { transform: translateX(calc( 0 * var(--step))); }
  100%                      { transform: translateX(calc(-1.5 * var(--step))); }
}

.tutorial-fake-popup{
  opacity: 0; pointer-events: none;
  padding: 4vh; border-radius: var(--radius);
  background: var(--color-gray70); color: var(--color-gray10); font-weight: bold;
  text-align: center; line-height: 1; box-shadow: 0 0 24px rgba(0,0,0,.35);
  animation: s4-popup $S4_DUR steps(1,end) infinite;
}
@keyframes s4-popup {
  0%, #{$P_POP_S - 0.01%}   { opacity: 0; }
  #{$P_POP_S}, #{$P_POP_E}  { opacity: 1; }
  #{$P_POP_E + 0.01%}, 100% { opacity: 0; }
}